---
title: "Network Effects Fixed Point Analysis"
format: html
---
This notebook recreates work previously shared with the CAS team, but now in a more formal source code.
The model will continue to grow, expand, and improve as we add new features.
These cells will create some of the graphs used in the paper, presentations, and test the plotting functions.
```{r}
source("./h2_adopt_model.R")
source("./h2_adopt_model_plots.R")
```


```{r}
# Create simple Nash Eq plot 
library(tidyverse)

# Set the model parameters using named vectors
my_model <- c("p_h" = 1.2
    , "f_h" = 3.0
    , "delta" = 0.04
    , "gamma" = 0.02
    , "x" = 2.0)

#curve_data = data.frame("s" = seq(0.0, 1.0, 0.001))
#curve_data["ks"] = adoption_curve(curve_data["s"], my_model)
#ne_data = data.frame("ne"=nash_equilibria(curve_data["s"], my_model))
plot_df <- ne_plot_simple_data(my_model)
# Pass model parameters to plot function
ne_plot_simple(plot_df[[1]], plot_df[[2]], "test_plot.pdf")
```


```{r}
plot_df2 <- ne_plot_recursive_data(my_model)
#ne_plot_recursive(plot_df2, my_model)
```


```{r}
        curve_df <- plot_df2[[1]]
        below_tipp_path <- plot_df2[[2]]
        above_tipp_path <- plot_df2[[3]]
        above_high_path <- plot_df2[[4]]
        ne_df <- plot_df2[[5]]

        ggplot(above_tipp_path, aes(x = x, y = y)) +
            # 45 degree line
            geom_line(data = curve_df, aes(x = s, y = s)
                , linewidth = 0.6
                , alpha = 0.7) +
            # Adoption curve
            geom_line(data = curve_df, aes(x = s, y = ac)
                , linewidth = 2.5
                , color = "aquamarine3") +
            # Dynamics below tipping point
            geom_point(data = below_tipp_path
                , fill = "magenta2"
                , size = 2
                , shape = 21) +
            geom_segment(data = below_tipp_path
                , aes(xend = after_stat(lead(x)), yend = after_stat(lead(y)))
                , arrow = arrow(length = unit(3, "mm"))
                , color = "magenta2") +
            # Dynamics above tipping point
            geom_point(data = above_tipp_path
                , fill = "coral2"
                , size = 2
                , shape = 21) +
            geom_segment(data = above_tipp_path
                , aes(xend = after_stat(lead(x)), yend = after_stat(lead(y)))
                , arrow = arrow(length = unit(3, "mm"))
                , color = "coral2") +
            # Dynamics above high equilibrium
            geom_point(data = above_high_path
                , fill = "purple3"
                , size = 2
                , shape = 21) +
            geom_segment(data = above_high_path
                , aes(xend = after_stat(lead(x)), yend = after_stat(lead(y)))
                , arrow = arrow(length = unit(3, "mm"))
                , color = "purple3") +
             # Equilibrium point markers, labels, etc.
            geom_point(data = ne_df, aes(x = ne, y = ne)
                , size = 3.5
                , shape = 19) +
            geom_label(data = ne_df
                , aes(x = ne, y = ne + 0.08, label = round(ne, 2))) +
            geom_text(label = "Tipping \nPoint"
                , x = ne_df[2, 1] - 0.01
                , y = ne_df[2, 1] + 0.22) +
            labs(
                title = "Recursive airport hydrogen adoption path"
              , subtitle = TeX(paste0(r"(Strategic forces, Nash equilibria and tipping points)", ''))
              , x = TeX(r"($S$: Proportion of airports adopting $H_2$)")
              , y = TeX(r"($1-G(S)$: Proportion of airports adopting $H_2$)")
            ) +
            theme_clean(base_size = 16)
```